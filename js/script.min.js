/*! mediatheque - v1.4.0-alpha - 2021-09-05 2:16:43 PM UTC - https://imathi.eu/tag/mediatheque */

window.wp=window.wp||{},window.mediaTheque=window.mediaTheque||_.extend({},_.pick(window.wp,"Backbone","template")),function(s){_.extend(mediaTheque,_.pick(window.wp,"media")),mediaTheque.post=mediaTheque.media.view.MediaFrame.Post,mediaTheque.embed=mediaTheque.media.controller.Embed,wp.media.controller.Embed=mediaTheque.embed.extend({initialize:function(e){var i,t=!1;e.metadata&&!_.isUndefined(e.metadata.url)&&(i=e.metadata.url.match(/user-media\/(.*?)\/\?attached=true/),_.isNull(i)||_.isUndefined(i[1])||(t=!0,i=e.metadata||{url:""},_.extend(i,{isMediaTheque:t}),this.props=new Backbone.Model(i))),t||mediaTheque.embed.prototype.initialize.apply(this,arguments)},activate:function(){mediaTheque.embed.prototype.activate.apply(this,arguments),this.props.get("isMediaTheque")&&(this.set({title:mediaThequeSettings.common.embedTitle}),this.frame.$el.addClass("mediatheque-hide-menu"))}}),mediaTheque.media.controller.UserMedia=wp.media.controller.State.extend({defaults:{id:"user-media",title:mediaThequeSettings.common.frameTitle,content:"user-media",menu:"default",toolbar:"main-user-media",priority:220},initialize:function(){this.set("userMediaSelection",new Backbone.Collection)},activate:function(){s(".media-frame-uploader").css({display:"none"}),_.isUndefined(this.frame.uploader.uploader)||(this.dropElement=this.frame.uploader.uploader.uploader.getOption("drop_element"),this.frame.uploader.uploader.uploader.setOption("drop_element",""))},deactivate:function(){s(".media-frame-uploader").css({display:"block"}),_.isUndefined(this.frame.uploader.uploader)||this.frame.uploader.uploader.uploader.setOption("drop_element",this.dropElement)}}),mediaTheque.media.view.Toolbar.UserMedia=mediaTheque.media.view.Toolbar.Select.extend({initialize:function(){_.defaults(this.options,{text:mediaThequeSettings.common.insertBtn,requires:!1}),this.userMediaSelection=this.controller.state().get("userMediaSelection"),this.userMediaSelection.on("add remove reset",this.refresh,this),mediaTheque.media.view.Toolbar.Select.prototype.initialize.apply(this,arguments)},refresh:function(){this.get("select").model.set("disabled",!this.userMediaSelection.length),mediaTheque.media.view.Toolbar.Select.prototype.refresh.apply(this,arguments)}}),mediaTheque.media.view.mainUserMedia=mediaTheque.media.View.extend({className:"user-media-content",template:mediaTheque.template("mediatheque-main"),initialize:function(){this.on("ready",this.loadApp,this)},loadApp:function(){var e=mediaTheque.App;!_.isUndefined(this.views._views[""])&&this.views._views[""].length||this.views.add(new mediaTheque.Views.Root({el:s("#mediatheque-container"),media:e.userMedia,overrides:e.overrides,toolbarItems:e.toolbarItems,queryVars:e.queryVars,trailItems:e.trailItems,uiType:"wp-editor",selection:this.controller.state().get("userMediaSelection")}))}}),mediaTheque.media.view.customizeImage=mediaTheque.media.view.EmbedImage.extend({className:"user-media-preferences",template:mediaTheque.template("image-details"),initialize:function(){var e,i=this.model.get("media"),t=i.get("guid").rendered,a=i.get("media_details");window.imageEdit&&(this.imageEdit=_.clone(window.imageEdit),window.imageEdit=!1),_.extend(a.sizes,{full:{width:a.width,height:a.height,mime_type:i.get("mime_type"),file:a.file}}),this.options.attachment.set({sizes:a.sizes,url:i.get("link")+mediaThequeSettings.common.downloadSlug+"/"},{silent:!0}),a.sizes.medium&&(e=a.file.split("/"),t=t.replace(e[e.length-1],a.sizes.medium.file)),this.model.set({url:t,base_url:i.get("link")},{silent:!0}),this.queryString=_.defaults(_.pick(this.model,["align","size"]),{attached:!0}),mediaTheque.media.view.EmbedImage.prototype.initialize.apply(this,arguments),this.on("ready",this.setFormElements,this)},prepare:function(){var e=!1;return this.options.attachment&&(e=this.options.attachment.toJSON()),_.defaults({model:this.model.toJSON(),attachment:e},this.options)},setFormElements:function(){this.$el.find(".caption, .alt-text, .advanced-toggle, #alt-text-description").css({display:"none"}),this.$el.find("input.link-to-custom").val(this.options.attachment.get("url")),this.$el.find("select.size").val("full"),this.$el.find('select.size option[value="full"]').prop("selected","selected"),this.$el.find('select.size option[value="custom"]').remove(),this.$el.find('.link-to select option[value="custom"]').remove(),this.imageEdit&&(window.imageEdit=_.clone(this.imageEdit),delete this.imageEdit)},updateChanges:function(e){mediaTheque.media.view.EmbedImage.prototype.updateChanges.apply(this,arguments),_.extend(this.queryString,_.pick(e.attributes,["align","link","size"])),this.model.metadata={url:this.model.get("base_url")+"?"+s.param(this.queryString)}}}),mediaTheque.media.view.customizeUserMedia=mediaTheque.media.view.Settings.extend({className:"user-media-preferences",initialize:function(){var e=this.model.get("media"),i={};this.options.query_keys=this.options.query_keys||["align","preload","loop","autoplay"],"video"===e.get("media_type")?(this.template=mediaTheque.template("video-details"),_.extend(i,_.pick(e.get("media_details"),["width","height"]))):"audio"===e.get("media_type")&&(this.template=mediaTheque.template("audio-details")),_.defaults(i,{src:e.get("guid").rendered,base_url:e.get("link")}),this.model.set(i,{silent:!0}),this.queryString=_.defaults(_.pick(this.model.attributes,this.options.query_keys),{attached:!0}),mediaTheque.media.view.Settings.prototype.initialize.apply(this,arguments),-1!==_.indexOf(["video","audio"],e.get("media_type"))&&this.on("ready",this.setFormElements,this)},setFormElements:function(){var e;"video"===this.model.get("media").get("media_type")?(this.$el.find(".wp-video-holder .setting").first().remove(),this.$el.find('[data-setting="content"]').remove(),this.$el.find(".setting").first().remove(),e=_.chain(mediaThequeSettings.common.alignBtns).map(function(e,i){return s("<button></button>").addClass("button").val(i).html(e)}).value(),this.$el.find(".embed-video-settings").append(s("<div></div>").addClass("setting align").html(s("<div></div>").addClass("button-group button-large").attr("data-setting","align").html(_.each(e,function(e){return s(e).html()}))).prepend(s("<span></span>").html(mediaThequeSettings.common.alignLabel)))):(this.$el.find("audio").css({visibility:"visible"}),this.$el.find(".embed-audio-settings label.setting").first().remove(),this.$el.find(".embed-audio-settings div.setting").first().remove())},updateChanges:function(i){mediaTheque.media.view.Settings.prototype.updateChanges.apply(this,arguments),_.extend(this.queryString,_.pick(i.attributes,this.options.query_keys)),_.each(this.options.query_keys,function(e){i.get(e)||this.$el.find('[data-setting="'+e+'"]').prop("checked",!1)},this),this.model.metadata={url:this.model.get("base_url")+"?"+s.param(this.queryString)}}}),mediaTheque.media.view.customizeFile=mediaTheque.media.view.customizeUserMedia.extend({initialize:function(){var e=this.options||{},t=0,a=e.model.get("media"),e=e.fields||[],s={};this.options.query_keys=[],this.collection=new Backbone.Collection,mediaTheque.media.view.customizeUserMedia.prototype.initialize.apply(this,arguments),this.model.props&&this.model.props.get("url")&&(s=mediaTheque.App.getURLparams(this.model.props.get("url"))),this.views.add(new mediaTheque.View({id:"mediatheque-file-preferences",className:"media-embed media-embed-details"})),this.views.add("#mediatheque-file-preferences",new mediaTheque.View({className:"embed-media-settings"})),_.each(e,function(e,i){t+=1,e.validate&&-1===_.indexOf(e.validate,a.get("mime_type"))||(this.collection.add({id:i,name:e.name,caption:e.caption||"",options:e.options||[],type:e.type||"",position:e.position||t,classes:e.classes||["setting",i],value:!_.isUndefined(s[i])&&JSON.parse(s[i])}),this.options.query_keys.push(i),this.addField(this.collection.get(i)))},this)},addField:function(e){this.views.add(".embed-media-settings",new mediaTheque.Views.Field({model:e},{at:e.position}))}}),wp.media.view.MediaFrame.Post=mediaTheque.post.extend({initialize:function(){_.extend(this.options,_.pick(mediaThequeSettings.common,"isUserMediaOnly")),mediaTheque.post.prototype.initialize.apply(this,arguments)},createStates:function(){var e=this.options,i={priority:20},t=[];e.isUserMediaOnly?e.gutenbergBlock?i.menu=!1:t.push(new wp.media.controller.Embed({metadata:e.metadata})):(i.priority=220,mediaTheque.post.prototype.createStates.apply(this,arguments)),t.unshift(new mediaTheque.media.controller.UserMedia(i)),this.states.add(t)},bindHandlers:function(){mediaTheque.post.prototype.bindHandlers.apply(this,arguments),this.options.isUserMediaOnly||this.on("menu:render:default",this.menuSeparator,this),this.on("toolbar:create:main-user-media",this.mainUserMediaToolbar,this),this.on("content:render:user-media",this.userMediaContent,this),this.state("user-media").on("select",this.insertUserMedia)},menuSeparator:function(e){e.set({"wordpress-separator":new wp.media.View({className:"separator",priority:200})})},mainUserMediaToolbar:function(e){e.view=new mediaTheque.media.view.Toolbar.UserMedia({controller:this})},userMediaContent:function(){this.options.isUserMediaOnly&&!_.isUndefined(this.uploader.uploader)&&this.uploader.uploader.uploader.setOption("drop_element","");var e=new mediaTheque.media.view.mainUserMedia({controller:this,model:this.state()}).render();this.content.set(e)},insertUserMedia:function(){var e,i,t=this.get("userMediaSelection"),a=void 0!==window.tinymce;if(!t.length)return!1;t=(i=_.first(t.models)).get("link"),a="publish"===i.get("status")?(t+="?attached=true",a&&window.tinymce.activeEditor&&!window.tinymce.activeEditor.isHidden()?"<p>"+t+"</p>":"\n\n"+t+"\n\n"):(e=i.get("title").rendered,wp.media.string.link({linkUrl:t,title:e})),this.frame.options.gutenbergBlock?((i=!(i=s(".block-editor-block-list__block.is-selected .mediatheque-block").get(0))&&s(".editor-block-list__block.is-selected .mediatheque-block").length?s(".editor-block-list__block.is-selected .mediatheque-block").get(0):i).dataset.link=t,e&&(i.dataset.title=e)):mediaTheque.media.editor.insert(a)},editMedia:function(e){var i,t=this.state();_.isUndefined(e.models)||1!==e.models.length||(i=_.first(e.models),e=mediaTheque.App.getURLparams(t.props.get("url")),i.set(_.pick(e,["size","align"])),t.set({media:i}),"image"===i.get("media_type")?this.customizeImageDisplay():this.customizeUserMediaDisplay())},customizeImageDisplay:function(){var e=this.state(),e=new mediaTheque.media.view.customizeImage({model:e,attachment:e.get("media"),controller:this,priority:40}).render();this.content.set(e)},customizeUserMediaDisplay:function(){var e=this.state(),i=e.get("media"),e=(-1!==_.indexOf(["video","audio"],i.get("media_type"))?new mediaTheque.media.view.customizeUserMedia({model:e,controller:this,priority:40}):new mediaTheque.media.view.customizeFile({model:e,fields:mediaThequeSettings.fields,controller:this,priority:40})).render();this.content.set(e)},embedContent:function(){var e=this.state();e.props.get("isMediaTheque")?(e=_.first(_.map(e.props.get("url").replace(mediaTheque.App.getRootURL(),"").split("?"),function(e,i){if(0===i)return e.replace("/","")})))&&(new wp.api.collections.UserMedia).fetch({data:{slug:e,user_media_context:"display-preferences"},success:_.bind(this.editMedia,this)}):mediaTheque.post.prototype.embedContent.apply(this,arguments)},mainEmbedToolbar:function(e){var i={controller:this};this.state().props.get("isMediaTheque")&&_.extend(i,{text:mediaThequeSettings.common.embedBtn}),e.view=new mediaTheque.media.view.Toolbar.Embed(i)}}),mediaTheque.media.personalAvatar={updateAvatar:function(e){var i=0;_.isObject(e)&&(i=e.get("id")),(new wp.api.models.UsersMe).save({meta:{personal_avatar:i}},{success:_.bind(this.avatarUpdated,this)})},avatarUpdated:function(e){var i={},e=e.get("avatar_urls")||{};e[96]&&(i={src:e[96]},e[192]?i.srcset=e[192]:i.srcset=e[96],s(".user-profile-picture").find("img").first().prop(i),s("#mediabrary-remove-message").remove())},frame:function(e){return this._frame?wp.media.frame=this._frame:(this._frame=mediaTheque.media({state:"user-media",states:[new mediaTheque.media.controller.UserMedia]}),this.activeEditor=e||"personal_avatar",this._frame.on("toolbar:create:main-user-media",function(e){e.view=new mediaTheque.media.view.Toolbar.UserMedia({controller:this,text:mediaThequeSettings.common.avatarBtn})},this._frame),this._frame.on("content:render:user-media",function(){var e=new mediaTheque.media.view.mainUserMedia({controller:this,model:this.state()}).render();this.content.set(e)},this._frame),this._frame.on("uploader:ready",function(){this.uploader.uploader.uploader.getOption("drop_element")&&(s(".media-frame-uploader").css({display:"none"}),this.uploader.uploader.uploader.setOption("drop_element",""))},this._frame),this._frame.state("user-media").on("select",this.select)),this._frame},select:function(){var e=this.get("userMediaSelection");if(!e.length)return!1;e=_.first(e.models),mediaTheque.media.personalAvatar.updateAvatar(e)},init:function(){s(".user-profile-picture td p.description").after(s("#personal-avatar-editor")),s("#personal-avatar-editor").on("click",".mediabrary-insert",function(e){e.preventDefault(),e.stopPropagation();e=s(e.currentTarget).data("editor");mediaTheque.media.personalAvatar.frame(e).open()}).on("click",".mediabrary-remove",function(){return mediaTheque.media.personalAvatar.updateAvatar(0),!1})}},s(mediaTheque.media.personalAvatar.init),mediaTheque.media.lightEditor={init:function(){var e,i;s(".mediatheque-buttons").length&&(i=s(".mediatheque-buttons").data("editor"),e={},i=s(".mediatheque-buttons").prev("#wp-"+i+"-editor-tools").find(".wp-editor-tabs").first(),s(i).before(s(".mediatheque-buttons:visible")),s(".mediatheque-insert .dashicons").prop("style").cssText&&(e.background=s(".mediatheque-insert .dashicons").prop("style").cssText),s(".mediatheque-insert .dashicons").css(_.extend(e,{display:"inline-block",width:"18px",height:"18px","vertical-align":"text-bottom",margin:"0 2px"}))),s(document.body).on("click",".mediatheque-insert",function(e){var i=s(e.currentTarget).data("editor"),t={frame:"post",state:"user-media",title:wp.media.view.l10n.addMedia,isUserMediaOnly:!0};e.preventDefault(),wp.media.editor.open(i,t),s(".media-frame-uploader").css({display:"none"})})}},s(mediaTheque.media.lightEditor.init),mediaTheque.App={init:function(e,i,t){this.views=new Backbone.Collection,this.userMedia=new wp.api.collections.UserMedia,this.toolbarItems=new Backbone.Collection,this.queryVars=new Backbone.Model,this.trailItems=new Backbone.Collection,this.overrides={url:e,file_data_name:"mediatheque_upload",headers:{"X-WP-Nonce":t}},this.rootUrl=i.replace("wp-json",mediaThequeSettings.common.rootSlug)},getURLparams:function(e,i){e=e?-1!==e.indexOf("?")?"?"+e.split("?")[1]:"":document.location.search;if(!e)return null;e=e.replace(/(^\?)/,"").split("&").map(function(e){return this[(e=e.split("="))[0]]=e[1],this}.bind({}))[0];return i?e[i]:e},getRootURL:function(){return mediaThequeSettings.common.networkRootUrl&&(this.rootUrl=mediaThequeSettings.common.networkRootUrl),this.rootUrl}},wp.api.loadPromise.done(function(e){var i,t,a;e.get("apiRoot")&&e.get("versionString")&&(i=(t=e.get("apiRoot"))+e.get("versionString")+"user-media",(a=e.get("nonce"))||(a=mediaThequeSettings.restNonce,e.set("nonce",a))),mediaTheque.App.init(i,t,a)})}((wp,jQuery));