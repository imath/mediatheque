/*! mediatheque - v1.1.0 - 2017-11-28 1:20:50 AM UTC - https://imathi.eu/tag/mediatheque */
window.wp=window.wp||{},window.mediaTheque=window.mediaTheque||_.extend({},_.pick(window.wp,"Backbone","template")),function(a,b){_.extend(mediaTheque,_.pick(window.wp,"media")),mediaTheque.post=mediaTheque.media.view.MediaFrame.Post,mediaTheque.embed=mediaTheque.media.controller.Embed,wp.media.controller.Embed=mediaTheque.embed.extend({initialize:function(a){var b,c=!1;if(a.metadata&&!_.isUndefined(a.metadata.url)&&(b=a.metadata.url.match(/user-media\/(.*?)\/\?attached=true/),!_.isNull(b)&&!_.isUndefined(b[1]))){c=!0;var d=a.metadata||{url:""};_.extend(d,{isMediaTheque:c}),this.props=new Backbone.Model(d)}c||mediaTheque.embed.prototype.initialize.apply(this,arguments)},activate:function(){mediaTheque.embed.prototype.activate.apply(this,arguments),this.props.get("isMediaTheque")&&(this.set({title:mediaThequeSettings.common.embedTitle}),this.frame.$el.addClass("mediatheque-hide-menu"))}}),mediaTheque.media.controller.UserMedia=wp.media.controller.State.extend({defaults:{id:"user-media",title:mediaThequeSettings.common.frameTitle,content:"user-media",menu:"default",toolbar:"main-user-media",priority:220},initialize:function(){this.set("userMediaSelection",new Backbone.Collection)},activate:function(){b(".media-frame-uploader").css({display:"none"}),_.isUndefined(this.frame.uploader.uploader)||(this.dropElement=this.frame.uploader.uploader.uploader.getOption("drop_element"),this.frame.uploader.uploader.uploader.setOption("drop_element",""))},deactivate:function(){b(".media-frame-uploader").css({display:"block"}),_.isUndefined(this.frame.uploader.uploader)||this.frame.uploader.uploader.uploader.setOption("drop_element",this.dropElement)}}),mediaTheque.media.view.Toolbar.UserMedia=mediaTheque.media.view.Toolbar.Select.extend({initialize:function(){_.defaults(this.options,{text:mediaThequeSettings.common.insertBtn,requires:!1}),this.userMediaSelection=this.controller.state().get("userMediaSelection"),this.userMediaSelection.on("add remove reset",this.refresh,this),mediaTheque.media.view.Toolbar.Select.prototype.initialize.apply(this,arguments)},refresh:function(){this.get("select").model.set("disabled",!this.userMediaSelection.length),mediaTheque.media.view.Toolbar.Select.prototype.refresh.apply(this,arguments)}}),mediaTheque.media.view.mainUserMedia=mediaTheque.media.View.extend({className:"user-media-content",template:mediaTheque.template("mediatheque-main"),initialize:function(){this.on("ready",this.loadApp,this)},loadApp:function(){var a=mediaTheque.App;!_.isUndefined(this.views._views[""])&&this.views._views[""].length||this.views.add(new mediaTheque.Views.Root({el:b("#mediatheque-container"),media:a.userMedia,overrides:a.overrides,toolbarItems:a.toolbarItems,queryVars:a.queryVars,trailItems:a.trailItems,uiType:"wp-editor",selection:this.controller.state().get("userMediaSelection")}))}}),mediaTheque.media.view.customizeImage=mediaTheque.media.view.EmbedImage.extend({className:"user-media-preferences",template:mediaTheque.template("image-details"),initialize:function(){var a,b=this.model.get("media"),c=b.get("guid").rendered,d=b.get("media_details");window.imageEdit&&(this.imageEdit=_.clone(window.imageEdit),window.imageEdit=!1),_.extend(d.sizes,{full:{width:d.width,height:d.height,mime_type:b.get("mime_type"),file:d.file}}),this.options.attachment.set({sizes:d.sizes,url:b.get("link")+mediaThequeSettings.common.downloadSlug+"/"},{silent:!0}),d.sizes.medium&&(a=d.file.split("/"),c=c.replace(a[a.length-1],d.sizes.medium.file)),this.model.set({url:c,base_url:b.get("link")},{silent:!0}),this.queryString=_.defaults(_.pick(this.model,["align","size"]),{attached:!0}),mediaTheque.media.view.EmbedImage.prototype.initialize.apply(this,arguments),this.on("ready",this.setFormElements,this)},prepare:function(){var a=!1;return this.options.attachment&&(a=this.options.attachment.toJSON()),_.defaults({model:this.model.toJSON(),attachment:a},this.options)},setFormElements:function(){this.$el.find(".caption, .alt-text, .advanced-toggle").css({display:"none"}),this.$el.find("input.link-to-custom").val(this.options.attachment.get("url")),this.$el.find("select.size").val("full"),this.$el.find('select.size option[value="full"]').prop("selected","selected"),this.$el.find('select.size option[value="custom"]').remove(),this.$el.find('.link-to select option[value="custom"]').remove(),this.imageEdit&&(window.imageEdit=_.clone(this.imageEdit),delete this.imageEdit)},updateChanges:function(a){mediaTheque.media.view.EmbedImage.prototype.updateChanges.apply(this,arguments),_.extend(this.queryString,_.pick(a.attributes,["align","link","size"])),this.model.metadata={url:this.model.get("base_url")+"?"+b.param(this.queryString)}}}),mediaTheque.media.view.customizeUserMedia=mediaTheque.media.view.Settings.extend({className:"user-media-preferences",initialize:function(){var a=this.model.get("media"),b={};this.options.query_keys=this.options.query_keys||["align","preload","loop","autoplay"],"video"===a.get("media_type")?(this.template=mediaTheque.template("video-details"),_.extend(b,_.pick(a.get("media_details"),["width","height"]))):"audio"===a.get("media_type")&&(this.template=mediaTheque.template("audio-details")),_.defaults(b,{src:a.get("guid").rendered,base_url:a.get("link")}),this.model.set(b,{silent:!0}),this.queryString=_.defaults(_.pick(this.model.attributes,this.options.query_keys),{attached:!0}),mediaTheque.media.view.Settings.prototype.initialize.apply(this,arguments),-1!==_.indexOf(["video","audio"],a.get("media_type"))&&this.on("ready",this.setFormElements,this)},setFormElements:function(){var a=this.model.get("media");if("video"===a.get("media_type")){this.$el.find(".wp-video-holder .setting").first().remove(),this.$el.find('[data-setting="content"]').remove(),this.$el.find(".setting").first().remove();var c=_.chain(mediaThequeSettings.common.alignBtns).map(function(a,c){return b("<button></button>").addClass("button").val(c).html(a)}).value();this.$el.find(".embed-video-settings").append(b("<div></div>").addClass("setting align").html(b("<div></div>").addClass("button-group button-large").attr("data-setting","align").html(_.each(c,function(a){return b(a).html()}))).prepend(b("<span></span>").html(mediaThequeSettings.common.alignLabel)))}else this.$el.find("audio").css({visibility:"visible"}),this.$el.find(".embed-audio-settings label.setting").first().remove(),this.$el.find(".embed-audio-settings div.setting").first().remove()},updateChanges:function(a){mediaTheque.media.view.Settings.prototype.updateChanges.apply(this,arguments),_.extend(this.queryString,_.pick(a.attributes,this.options.query_keys)),this.model.metadata={url:this.model.get("base_url")+"?"+b.param(this.queryString)}}}),mediaTheque.media.view.customizeFile=mediaTheque.media.view.customizeUserMedia.extend({initialize:function(){var a=this.options||{},b=0,c=a.fields||[],d={};this.options.query_keys=[],this.collection=new Backbone.Collection,mediaTheque.media.view.customizeUserMedia.prototype.initialize.apply(this,arguments),this.model.props&&this.model.props.get("url")&&(d=mediaTheque.App.getURLparams(this.model.props.get("url"))),this.views.add(new mediaTheque.View({id:"mediatheque-file-preferences",className:"media-embed media-embed-details"})),this.views.add("#mediatheque-file-preferences",new mediaTheque.View({className:"embed-media-settings"})),_.each(c,function(a,c){b+=1,this.collection.add({id:c,name:a.name,caption:a.caption||"",options:a.options||[],type:a.type||"",position:a.position||b,classes:a.classes||["setting",c],value:!_.isUndefined(d[c])&&JSON.parse(d[c])}),this.options.query_keys.push(c),this.addField(this.collection.get(c))},this)},addField:function(a){this.views.add(".embed-media-settings",new mediaTheque.Views.Field({model:a},{at:a.position}))}}),wp.media.view.MediaFrame.Post=mediaTheque.post.extend({initialize:function(){_.extend(this.options,_.pick(mediaThequeSettings.common,"isUserMediaOnly")),mediaTheque.post.prototype.initialize.apply(this,arguments)},createStates:function(){var a=this.options,b={priority:20},c=[];a.isUserMediaOnly?a.gutenbergBlock?b.menu=!1:c.push(new wp.media.controller.Embed({metadata:a.metadata})):(b.priority=220,mediaTheque.post.prototype.createStates.apply(this,arguments)),c.unshift(new mediaTheque.media.controller.UserMedia(b)),this.states.add(c)},bindHandlers:function(){mediaTheque.post.prototype.bindHandlers.apply(this,arguments),this.options.isUserMediaOnly||this.on("menu:render:default",this.menuSeparator,this),this.on("toolbar:create:main-user-media",this.mainUserMediaToolbar,this),this.on("content:render:user-media",this.userMediaContent,this),this.state("user-media").on("select",this.insertUserMedia)},menuSeparator:function(a){a.set({"wordpress-separator":new wp.media.View({className:"separator",priority:200})})},mainUserMediaToolbar:function(a){a.view=new mediaTheque.media.view.Toolbar.UserMedia({controller:this})},userMediaContent:function(){this.options.isUserMediaOnly&&!_.isUndefined(this.uploader.uploader)&&this.uploader.uploader.uploader.setOption("drop_element","");var a=new mediaTheque.media.view.mainUserMedia({controller:this,model:this.state()}).render();this.content.set(a)},insertUserMedia:function(){var a,c,d,e,f=this.get("userMediaSelection");if(!f.length)return!1;if(a=_.first(f.models),c=a.get("link"),"publish"===a.get("status")?(c+="?attached=true",e="<p>"+c+"</p>"):(d=a.get("title").rendered,e=wp.media.string.link({linkUrl:c,title:d})),this.frame.options.gutenbergBlock){var g=b(".editor-visual-editor__block.is-selected .mediatheque-block").get(0);g.dataset.link=c,d&&(g.dataset.title=d)}else mediaTheque.media.editor.insert(e)},editMedia:function(a){var b,c,d=this.state();_.isUndefined(a.models)||1!==a.models.length||(b=_.first(a.models),c=mediaTheque.App.getURLparams(d.props.get("url")),b.set(_.pick(c,["size","align"])),d.set({media:b}),"image"===b.get("media_type")?this.customizeImageDisplay():this.customizeUserMediaDisplay())},customizeImageDisplay:function(){var a=this.state(),b=new mediaTheque.media.view.customizeImage({model:a,attachment:a.get("media"),controller:this,priority:40}).render();this.content.set(b)},customizeUserMediaDisplay:function(){var a,b=this.state(),c=b.get("media");a=-1!==_.indexOf(["video","audio"],c.get("media_type"))?new mediaTheque.media.view.customizeUserMedia({model:b,controller:this,priority:40}).render():new mediaTheque.media.view.customizeFile({model:b,fields:mediaThequeSettings.fields,controller:this,priority:40}).render(),this.content.set(a)},embedContent:function(){var a,b,c=this.state();c.props.get("isMediaTheque")?(a=_.first(_.map(c.props.get("url").replace(mediaTheque.App.getRootURL(),"").split("?"),function(a,b){if(0===b)return a.replace("/","")})),a&&(b=new wp.api.collections.UserMedia,b.fetch({data:{slug:a,user_media_context:"display-preferences"},success:_.bind(this.editMedia,this)}))):mediaTheque.post.prototype.embedContent.apply(this,arguments)},mainEmbedToolbar:function(a){var b={controller:this},c=this.state();c.props.get("isMediaTheque")&&_.extend(b,{text:mediaThequeSettings.common.embedBtn}),a.view=new mediaTheque.media.view.Toolbar.Embed(b)}}),mediaTheque.media.personalAvatar={updateAvatar:function(a){var b,c=0;_.isObject(a)&&(c=a.get("id")),b=new wp.api.models.UsersMe,b.save({meta:{personal_avatar:c}},{success:_.bind(this.avatarUpdated,this)})},avatarUpdated:function(a){var c={},d=a.get("avatar_urls")||{};d[96]&&(c={src:d[96]},d[192]?c.srcset=d[192]:c.srcset=d[96],b(".user-profile-picture").find("img").first().prop(c),b("#mediabrary-remove-message").remove())},frame:function(a){return this._frame?(wp.media.frame=this._frame,this._frame):(this._frame=mediaTheque.media({state:"user-media",states:[new mediaTheque.media.controller.UserMedia]}),this.activeEditor=a||"personal_avatar",this._frame.on("toolbar:create:main-user-media",function(a){a.view=new mediaTheque.media.view.Toolbar.UserMedia({controller:this,text:mediaThequeSettings.common.avatarBtn})},this._frame),this._frame.on("content:render:user-media",function(){var a=new mediaTheque.media.view.mainUserMedia({controller:this,model:this.state()}).render();this.content.set(a)},this._frame),this._frame.on("uploader:ready",function(){this.uploader.uploader.uploader.getOption("drop_element")&&(b(".media-frame-uploader").css({display:"none"}),this.uploader.uploader.uploader.setOption("drop_element",""))},this._frame),this._frame.state("user-media").on("select",this.select),this._frame)},select:function(){var a,b=this.get("userMediaSelection");return!!b.length&&(a=_.first(b.models),void mediaTheque.media.personalAvatar.updateAvatar(a))},init:function(){b(".user-profile-picture td p.description").after(b("#personal-avatar-editor")),b("#personal-avatar-editor").on("click",".mediabrary-insert",function(a){a.preventDefault(),a.stopPropagation();var c=b(a.currentTarget).data("editor");mediaTheque.media.personalAvatar.frame(c).open()}).on("click",".mediabrary-remove",function(){return mediaTheque.media.personalAvatar.updateAvatar(0),!1})}},b(mediaTheque.media.personalAvatar.init),mediaTheque.media.lightEditor={init:function(){if(b(".mediatheque-buttons").length){var a=b(".mediatheque-buttons").data("editor"),c={},d=b(".mediatheque-buttons").prev("#wp-"+a+"-editor-tools").find(".wp-editor-tabs").first();b(d).before(b(".mediatheque-buttons:visible")),b(".mediatheque-insert .dashicons").prop("style").cssText&&(c.background=b(".mediatheque-insert .dashicons").prop("style").cssText),b(".mediatheque-insert .dashicons").css(_.extend(c,{display:"inline-block",width:"18px",height:"18px","vertical-align":"text-bottom",margin:"0 2px"}))}b(document.body).on("click",".mediatheque-insert",function(a){var c=b(a.currentTarget),d=c.data("editor"),e={frame:"post",state:"user-media",title:wp.media.view.l10n.addMedia,isUserMediaOnly:!0};a.preventDefault(),wp.media.editor.open(d,e),b(".media-frame-uploader").css({display:"none"})})}},b(mediaTheque.media.lightEditor.init),mediaTheque.App={init:function(a,b){this.views=new Backbone.Collection,this.userMedia=new wp.api.collections.UserMedia,this.toolbarItems=new Backbone.Collection,this.queryVars=new Backbone.Model,this.trailItems=new Backbone.Collection,this.overrides={url:a,file_data_name:"mediatheque_upload",headers:{"X-WP-Nonce":wpApiSettings.nonce}},this.rootUrl=b.replace("wp-json",mediaThequeSettings.common.rootSlug)},getURLparams:function(a,b){var c;if(c=a?-1!==a.indexOf("?")?"?"+a.split("?")[1]:"":document.location.search,!c)return null;var d=c.replace(/(^\?)/,"").split("&").map(function(a){return a=a.split("="),this[a[0]]=a[1],this}.bind({}))[0];return b?d[b]:d},getRootURL:function(){return mediaThequeSettings.common.networkRootUrl&&(this.rootUrl=mediaThequeSettings.common.networkRootUrl),this.rootUrl}},wp.api.loadPromise.done(function(a){var b,c;a.get("apiRoot")&&a.get("versionString")&&(c=a.get("apiRoot"),b=c+a.get("versionString")+"user-media"),mediaTheque.App.init(b,c)})}(wp,jQuery);