/*! mediatheque - v1.4.0-alpha - 2021-09-05 2:16:43 PM UTC - https://imathi.eu/tag/mediatheque */

window.wp=window.wp||{},window.mediaTheque=window.mediaTheque||_.extend({},_.pick(window.wp,"Backbone","template")),function(t){mediaTheque.Models=mediaTheque.Models||{},mediaTheque.Collections=mediaTheque.Collections||{},mediaTheque.Views=mediaTheque.Views||{},mediaTheque.Models.File=wp.api.WPApiBaseModel.extend({file:{},save:function(e,i){return Backbone.Model.prototype.save.call(this,e,i)},destroy:function(e,i,d){return _.isUndefined(this.urlRoot)?(this.clear(),this.trigger("destroy",this,this.collection,e),!1):Backbone.Model.prototype.destroy.call(this,e,i,d)}}),mediaTheque.Uploader=function(e){var i,o=this;e.overrides&&(i=e.overrides,delete e.overrides),wp.Uploader.call(this,e),i&&_.each(i,function(e,i){o.uploader.settings[i]=e,"headers"===i&&(delete o.uploader.settings.multipart_params._wpnonce,_.extend(o.uploader.settings.multipart_params,e,{action:"upload_user_media"}))}),_.isUndefined(o.uploader.settings.filters.mime_types)||(o.uploader.settings.filters.mime_types=[]),this.filesQueue=new Backbone.Collection,this.filesUploaded=new Backbone.Collection,this.filesError=new Backbone.Collection,this.uploader.unbind("FilesAdded, UploadProgress, FileUploaded, Error");function a(e,i,d){d.userMedia&&d.userMedia.destroy(),o.filesError.add({feedback:e||pluploadL10n.default_error,data:i,file:d}),o.error(e,i,d)}this.uploader.bind("FilesAdded",function(e,i){_.each(i,function(e){var i,d;plupload.FAILED!==e.status&&(i=_.extend({id:e.id,file:e,uploading:!0,date:new Date,filename:e.name},_.pick(e,"loaded","size","percent")),(d=/(?:jpe?g|png|gif)$/i.exec(e.name))&&(i.type="image",i.subtype="jpg"===d[0]?"jpeg":d[0]),e.userMedia=new mediaTheque.Models.File(i),o.filesQueue.add(e.userMedia),o.added(e.userMedia))}),e.refresh(),e.start()}),this.uploader.bind("UploadProgress",function(e,i){i.userMedia.set(_.pick(i,"loaded","percent"))}),this.uploader.bind("FileUploaded",function(e,i,d){var r;try{r=d.status,d=JSON.parse(d.response)}catch(e){return a(pluploadL10n.default_error,e,i)}return!_.isObject(d)||_.isUndefined(r)?a(pluploadL10n.default_error,null,i):201!==r?a(d.data&&d.data.message,d.data,i):(_.each(["file","loaded","size","percent"],function(e){i.userMedia.unset(e)}),i.userMedia.set(_.extend(d,{uploading:!1})),o.filesUploaded.add(i.userMedia),void o.success(i.userMedia))}),this.uploader.bind("BeforeUpload",function(e,i){t(o).trigger("mediatheque-new-upload",e,i)}),this.uploader.bind("UploadComplete",function(e,i){t(o).trigger("mediatheque-upload-complete",e,i),o.filesQueue.reset()}),this.uploader.bind("Error",function(e,i){var d,r=pluploadL10n.default_error;if(_.isUndefined(i.response)){for(d in wp.Uploader.errorMap)if(i.code===plupload[d]){r=wp.Uploader.errorMap[d],_.isFunction(r)&&(r=r(i.file,i));break}}else i.response=JSON.parse(i.response),_.isUndefined(i.response.message)||(r=i.response.message);a(r,i,i.file),t(o).trigger("mediatheque-upload-error",e,i),e.refresh()})},t.extend(mediaTheque.Uploader.prototype,{init:function(){},success:function(){},added:function(){},progress:function(){},complete:function(){},error:function(){},refresh:function(){wp.Uploader.prototype.refresh.apply(this,arguments)},param:function(){wp.Uploader.prototype.param.apply(this,arguments)}})}(jQuery);