/*! mediatheque - v1.0.0-beta2 - 2017-05-23 4:31:48 PM UTC - https://imathi.eu/tag/mediatheque */
window.wp=window.wp||{},window.mediaTheque=window.mediaTheque||_.extend({},_.pick(window.wp,"Backbone","template")),function(a){mediaTheque.Models=mediaTheque.Models||{},mediaTheque.Collections=mediaTheque.Collections||{},mediaTheque.Views=mediaTheque.Views||{},mediaTheque.Models.File=wp.api.WPApiBaseModel.extend({file:{},save:function(a,b){return Backbone.Model.prototype.save.call(this,a,b)},destroy:function(a,b,c){return _.isUndefined(this.urlRoot)?(this.clear(),this.trigger("destroy",this,this.collection,a),!1):Backbone.Model.prototype.destroy.call(this,a,b,c)}}),mediaTheque.Uploader=function(b){var c,d=this;b.overrides&&(c=b.overrides,delete b.overrides),wp.Uploader.call(this,b),c&&_.each(c,function(a,b){d.uploader.settings[b]=a,"headers"===b&&(delete d.uploader.settings.multipart_params._wpnonce,_.extend(d.uploader.settings.multipart_params,a,{action:"upload_user_media"}))}),_.isUndefined(d.uploader.settings.filters.mime_types)||(d.uploader.settings.filters.mime_types=[]),this.filesQueue=new Backbone.Collection,this.filesUploaded=new Backbone.Collection,this.filesError=new Backbone.Collection,this.uploader.unbind("FilesAdded, UploadProgress, FileUploaded, Error");var e=function(a,b,c){c.userMedia&&c.userMedia.destroy(),d.filesError.add({feedback:a||pluploadL10n.default_error,data:b,file:c}),d.error(a,b,c)};this.uploader.bind("FilesAdded",function(a,b){_.each(b,function(a){var b,c;plupload.FAILED!==a.status&&(b=_.extend({id:a.id,file:a,uploading:!0,date:new Date,filename:a.name},_.pick(a,"loaded","size","percent")),c=/(?:jpe?g|png|gif)$/i.exec(a.name),c&&(b.type="image",b.subtype="jpg"===c[0]?"jpeg":c[0]),a.userMedia=new mediaTheque.Models.File(b),d.filesQueue.add(a.userMedia),d.added(a.userMedia))}),a.refresh(),a.start()}),this.uploader.bind("UploadProgress",function(a,b){b.userMedia.set(_.pick(b,"loaded","percent"))}),this.uploader.bind("FileUploaded",function(a,b,c){var f;try{f=c.status,c=JSON.parse(c.response)}catch(a){return e(pluploadL10n.default_error,a,b)}return!_.isObject(c)||_.isUndefined(f)?e(pluploadL10n.default_error,null,b):201!==f?e(c.data&&c.data.message,c.data,b):(_.each(["file","loaded","size","percent"],function(a){b.userMedia.unset(a)}),b.userMedia.set(_.extend(c,{uploading:!1})),d.filesUploaded.add(b.userMedia),void d.success(b.userMedia))}),this.uploader.bind("BeforeUpload",function(b,c){a(d).trigger("mediatheque-new-upload",b,c)}),this.uploader.bind("UploadComplete",function(b,c){a(d).trigger("mediatheque-upload-complete",b,c),d.filesQueue.reset()}),this.uploader.bind("Error",function(b,c){var f,g=pluploadL10n.default_error;if(_.isUndefined(c.response)){for(f in wp.Uploader.errorMap)if(c.code===plupload[f]){g=wp.Uploader.errorMap[f],_.isFunction(g)&&(g=g(c.file,c));break}}else c.response=JSON.parse(c.response),_.isUndefined(c.response.message)||(g=c.response.message);e(g,c,c.file),a(d).trigger("mediatheque-upload-error",b,c),b.refresh()})},a.extend(mediaTheque.Uploader.prototype,{init:function(){},success:function(){},added:function(){},progress:function(){},complete:function(){},error:function(){},refresh:function(){wp.Uploader.prototype.refresh.apply(this,arguments)},param:function(){wp.Uploader.prototype.param.apply(this,arguments)}})}(jQuery);